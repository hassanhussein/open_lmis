<!--
  ~ This program is part of the OpenLMIS logistics management information system platform software.
  ~ Copyright © 2013 VillageReach
  ~
  ~ This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
  ~  
  ~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details.
  ~ You should have received a copy of the GNU Affero General Public License along with this program.  If not, see http://www.gnu.org/licenses.  For additional information contact info@OpenLMIS.org. 
  -->

<div ng-controller="CreatePatientLineItemController">
    <div>    <input
            id="showSkippedProductModal"
            ng-disabled="((rnr.status != 'INITIATED' && rnr.status != 'SUBMITTED') || rnr.status == 'SUBMITTED' && !hasPermission('AUTHORIZE_REQUISITION'))"
            type="button"
            ng-click="showAddSkippedRegimensModal()"
            class="pull-right btn btn-primary"
            openlmis-message="button.add.regimen"/>
    </div>
    <div class="clearfix"></div>
    <div class="rnr-table" tab-scroll bottom-offset="180" adjust-height ng-show="rnr.program.code ==='TB-MDR'">
        <div class="float-left left-table parent">
            <table id="fullSupplyFrozenTable" class="table table-bordered" fixed-table-header>
                <thead>
                <tr>
                    <th class="col-{{patientColumn.name}}"  ng-repeat="patientColumn in patientColumns | filter:{fixed : true}">
                        <ng-switch on="patientColumn.name">
                           <span ng-if="patientColumn.name == 'skipped'">
                              <a href="" id="selectAll" ng-click="setSkipAll(true)"
                                 openlmis-message="label.select.all"></a>&nbsp;|
                              <a href="" id="selectNone" ng-click="setSkipAll(false)"
                                 openlmis-message="label.select.none"></a>
                          </span>
                        <div ng-switch-default  class="regimen-heading">
                            <span style="float: right;position: relative;left: -50%; text-align: left;"  openlmis-message="patientColumn.label"></span>
                        </div>
                        </ng-switch>
                    </th>
                </tr>
                </thead>
                <tbody  ng-repeat="patientLineItem in page.patient">
                <tr ng-show="!patientLineItem.skipped ">
                    <td class="productCategory" colspan="{{(patientColumns|filter:{fixed : true}).length}}"
                        ng-show="showCategory($index)"
                        ng-bind="patientLineItem.category.name"></td>
                </tr>
                <tr ng-show="!patientLineItem.skipped ">
                    <td class="cell-input col-{{ patientColumn.name }}"
                        ng-repeat="patientColumn in patientColumns | filter:{fixed : true}">
                        <ng-switch on="patientColumn.name">
                          <span ng-switch-when="monthOfTreatment" class="cell-text" >
                            <span  ng-bind="patientLineItem.name" class="padding2px"></span>
                          </span>
                            <span ng-switch-when="skipped" class="col-skipped">
                            <input id="skip_{{patientLineItem.id}}" ng-model="patientLineItem.skipped" type="checkbox"/>
                          </span>
                        </ng-switch>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="float-left right-table parent" custom-horizontal-scroll>
            <table id="regimenTable" fixed-table-header class="table table-bordered scrollable">
                <thead>
                <tr>
                    <th class="col-{{patientColumn.name}}"
                        ng-repeat="patientColumn in patientColumns | filter:{fixed : false} ">
                        <div class="regimen-heading">
                            <span style="float: right;position: relative;left: -50%; text-align: left;" openlmis-message="patientColumn.label"></span>
                        </div>
                    </th>
                </tr>
                </thead>
                <tbody ng-repeat="patientLineItem in page.patient ">
                <tr ng-show="!patientLineItem.skipped">
                    <td class="productCategory" colspan="{{visibleColumns.fullSupply.scrollable.length + 14}}"
                        ng-show="showCategory($index)">&nbsp;
                    </td>
                </tr>
                <tr ng-show="!patientLineItem.skipped">
                    <td class="cell-input col-beginningBalance"
                        ng-repeat="patientColumn in patientColumns | filter:{fixed : false}">
                        <ng-switch on="patientColumn.name">
                          <span ng-switch-when="name" class="cell-text">
                            <span ng-bind="patientLineItem.name" class="padding2px"></span>
                          </span>
                            <span ng-switch-default  class="position-relative" >
                                 <input
                                         ng-required="false"
                                        ng-disabled="disableInputMDR($index + 1, patientLineItem.patientDisplayOrder, patientLineItem.code) || (patientLineItem.skipped && !patientLineItem[patientColumn.name])"
                                        type="text"
                                        ng-model="patientLineItem[patientColumn.name]"
                                        maxlength="8"
                                        ng-class="highlightPatientRequired(showError, patientLineItem[patientColumn.name], disableInputMDR($index + 1, patientLineItem.patientDisplayOrder, patientLineItem.code ), patientLineItem['skipped'])"/>
                                 <span class="rnr-form-error"
                                       style="display:none;" openlmis-message="error.number.only">
                                 </span>
                          </span>
                        </span>

                            </span>
                        </ng-switch>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="clear-both"></div>
    </div>
    <div class="rnr-table" tab-scroll bottom-offset="180" adjust-height ng-show="rnr.program.code !=='TB-MDR'">
        <div class="float-left left-table parent">
            <table id="fullSupplyFrozenTable" class="table table-bordered" fixed-table-header>
                <thead>
                <tr>
                    <th class="col-{{patientColumn.name}}"
                        ng-repeat="patientColumn in patientColumns | filter:{fixed : true}">
                        <ng-switch on="patientColumn.name">
                           <span ng-if="patientColumn.name == 'skipped'">
                              <a href="" id="selectAll" ng-click="setSkipAll(true)"
                                 openlmis-message="label.select.all"></a>&nbsp;|
                              <a href="" id="selectNone" ng-click="setSkipAll(false)"
                                 openlmis-message="label.select.none"></a>
                          </span>
                            <div ng-switch-default  class="regimen-heading">
                                <span style="float: right;position: relative;left: -50%; text-align: left;"  openlmis-message="patientColumn.label"></span>
                            </div>
                        </ng-switch>
                    </th>
                </tr>
                </thead>
                <tbody ng-repeat="patientLineItem in page.patient">
                <tr>
                    <td class="productCategory" colspan="{{(patientColumns|filter:{fixed : true}).length}}"
                        ng-show="showCategory($index)"
                        ng-bind="patientLineItem.category.name"></td>
                </tr>
                <tr>
                    <td class="cell-input col-{{ patientColumn.name }}"
                        ng-repeat="patientColumn in patientColumns | filter:{fixed : true}">
                        <ng-switch on="patientColumn.name">
                          <span ng-switch-when="monthOfTreatment" class="cell-text" >
                            <span  ng-bind="patientLineItem.name" class="padding2px"></span>
                          </span>
                            <span ng-switch-when="skipped" class="col-skipped">
                            <input id="skip_{{patientLineItem.id}}" ng-model="patientLineItem.skipped" type="checkbox"/>
                          </span>
                        </ng-switch>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="float-left right-table parent" custom-horizontal-scroll>
            <table id="regimenTable" fixed-table-header class="table table-bordered scrollable">
                <thead>
                <tr>
                    <th class="col-{{patientColumn.name}}"
                        ng-repeat="patientColumn in patientColumns | filter:{fixed : false}">
                        <div class="regimen-heading">
                            <span style="float: right;position: relative;left: -50%; text-align: left;" openlmis-message="patientColumn.label"></span>
                        </div>
                    </th>
                </tr>
                </thead>
                <tbody ng-repeat="patientLineItem in page.patient">
                <tr>
                    <td class="productCategory" colspan="{{visibleColumns.fullSupply.scrollable.length + 14}}"
                        ng-show="showCategory($index)">&nbsp;
                    </td>
                </tr>
                <tr>
                    <td class="cell-input col-beginningBalance"
                        ng-repeat="patientColumn in patientColumns | filter:{fixed : false}">
                        <ng-switch on="patientColumn.name">
                          <span ng-switch-when="name" class="cell-text">
                            <span ng-bind="patientLineItem.name" class="padding2px"></span>
                          </span>
                            <span ng-switch-default  class="position-relative" >
                                 <input
                                         ng-required="false"
                                         ng-disabled="disableInput($index + 1, patientLineItem.patientDisplayOrder, patientLineItem.code ) || (patientLineItem.skipped && !patientLineItem[patientColumn.name])"
                                         type="text"
                                         ng-model="patientLineItem[patientColumn.name]"
                                         maxlength="8"
                                         ng-class="highlightPatientRequired(showError, patientLineItem[patientColumn.name], disableInput($index + 1, patientLineItem.patientDisplayOrder, patientLineItem.code ), patientLineItem['skipped'])"/>
                                 <span class="rnr-form-error"
                                       style="display:none;" openlmis-message="error.number.only">
                                 </span>
                          </span>
                            </span>

                            </span>
                        </ng-switch>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="clear-both"></div>
    </div>
    <form name="addSkippedProductForm">
        <div id="addSkippedProductsModal" modal="addSkippedProductsModal"
             options="{ backdrop: 'static', escape: false}">
            <div class="modal-header"><h3 openlmis-message="button.add.regimen"></h3></div>
            <div class="modal-body">

                <div class="row-fluid">
                    <div class="span12">
                        <label for="filterSkipped">
                            <span openlmis-message="rnr.search.regimen"> </span>
                        </label>
                        <input id="filterSkipped" type="text" class="large" ng-model="filterText"/>
                    </div>
                    <div class="span12" style="max-height: 240px ; overflow:scroll">
                        <table class="table table-bordered">
                            <thead>
                            <tr class="gradient-header">
                                <th openlmis-message="rnr.header.add"></th>
                                <th openlmis-message="rnr.header.code"></th>
                                <th openlmis-message="rnr.header.regimen.name"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr ng-repeat-start="row in filtered = ($parent.$parent.rnr.patientLineItems | filter: {category.name: filterText})"></tr>
                            <tr ng-show="( $index == 0 || ($index > 0 && filtered[$index - 1].productCategory != row.productCategory))">
                                <td colspan="3" class="productCategory">
                                    {{row.productCategory}}
                                </td>
                            </tr>
                            <tr ng-show="row.skipped">
                                <td class="cell-input" style="text-align: center;">
                                    <input type="checkbox" id="skipped-row-{{row.id}}" ng-model="row.unskip"/>
                                </td>
                                <td class="cell-input">
                                    <label for="skipped-row-{{row.id}}">
                                        <span class="cell-text">{{row.code}}</span>
                                    </label>
                                </td>
                                <td class="cell-input">
                                    <label for="skipped-row-{{row.id}}">
                                        <span class="cell-text">{{row.category.name}}</span>
                                    </label>
                                </td>
                            </tr>
                            <tr ng-repeat-end></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="clearfix"></div>
                    <div class="span12">
                        <a href="" class="btn btn-primary" ng-click="unskipRegimens($parent.$parent.rnr)">Add Selected Regimen</a>
                        <a href="" ng-click="addSkippedProductsModal=false;" class="btn btn-cancel">Cancel</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>