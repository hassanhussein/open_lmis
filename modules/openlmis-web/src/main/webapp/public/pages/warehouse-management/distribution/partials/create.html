<!--
  ~ This program is part of the OpenLMIS logistics management information system platform software.
  ~ Copyright Â© 2013 VillageReach
  ~
  ~  This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
  ~
  ~  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details.
  ~  You should have received a copy of the GNU Affero General Public License along with this program.  If not, see http://www.gnu.org/licenses.  For additional information contact info@OpenLMIS.org.
  -->


<div xmlns="http://www.w3.org/1999/html" tab-scroll>
    <div>
        <h2 >Vaccine Distribution</h2>


    </div>


    <form name="distributionForm"  novalidate>
        <div class="app-form">

            <div class="form-group clear-top">

                <div class="form-row clearfix">



                    <div class="span3">
                        <label for="receiptDate">
                            <span>Distribution Date</span>
                            <span class="label-required"> *</span>
                        </label>

                        <div class="form-field">
                            <input id="receiptDate"
                                   type="text" autocomplete="off"
                                   ui-date="{dateFormat: 'dd/mm/yy', changeYear: false,maxDate:'today',minDate:period.stringStartDate}"
                                   ui-date-format="yy-mm-dd"
                                   ng-model="distributionDate" name="distributionDate"
                                   ng-disabled="viewMode"
                                   ng-required="true"/>
                            <span class="field-error" ng-show="distributionForm.distributionDate.$error.required && showError"
                                  openlmis-message="missing.value"></span>
                        </div>
                    </div>

                    <div class="span3">
                        <label for="supplier" >Distribution Type <span class="label-required"> *</span></label>


                        <div class="form-field row-fluid">
                            <select ui-select2="{width: '90%'}" class="span11" id="supplier"
                                    openlmis-message="label.select.parent.zone"
                                    ng-disabled="viewMode"
                                    name="distributionType"
                                    ng-required="true"
                                    ng-model="distributionType">
                                <option value="ROUTINE">Routine</option>
                                <option value="CAMPAIGN">Campaign</option>


                            </select>
                            <span class="field-error" ng-show="asnForm.supplier.$error.required && showError"
                                  openlmis-message="missing.value"></span>
                        </div>
                    </div>

                </div>

                <br>

                <div class="alert alert-danger" ng-show="vialPresentationErrorList.length">
                    <ul>
                        <li ng-repeat="error in vialPresentationErrorList">{{error}}</li>
                    </ul>

                </div>


                <div class="alert alert-danger" ng-show="allFieldsFieldErrorList.length">
                    <ul>
                        <li ng-repeat="error in allFieldsFieldErrorList">{{error}}</li>
                    </ul>

                </div>

                <div class="alert alert-danger" ng-show="issuedErrorList.length">
                    <ul>
                        <li ng-repeat="error in issuedErrorList">{{error}}</li>
                    </ul>

                </div>

                <div class="rnr-table">
                    <div style="width:40%;" class="float-left left-table parent">
                        <table class="table table-bordered" fixed-table-header>
                            <thead>
                            <tr class="gradient-header" style="height:55px">
                                <th  colspan="5" style="text-align:center"> Distribute to:</th>
                            </tr>
                            <tr class="gradient-header inner-tr-height">
                                <th style="width:20px; min-width:20px;">Batch</th>
                                <th style="width:20px; min-width:20px;">Bin Location</th>
                                <th style="width:14px; min-width:14px;" >VVM</th>
                                <th  style="width:69px; min-width:25px;" >Exp Date</th>
                                <th style="width:45px; min-width:25px;" >SOH(Doses)</th>
                            </tr>
                            </thead>

                            <tbody>
                            <tr ng-repeat-start="p in soh" class="inner-tr-height">
                                <th  colspan="5">{{p.product}}</th>
                            </tr>
<!--                            <tr class="gradient-header inner-tr-height">-->
<!--                                <th >Batch</th>-->
<!--                                <th >VVM</th>-->
<!--                                <th >Exp Date</th>-->
<!--                                <th >SOH</th>-->
<!--                            </tr>-->
                            <tr ng-repeat-end ng-repeat="lot in p.lots" ng-init="lotIndex = $index" class="inner-tr-height">
                                <td >{{lot.number}}</td>
                                <td >{{lot.binLocation}}</td>


                                <td >{{lot.vvm}}</td>
                                <td >{{lot.expiry}}</td>
                                <td style="text-align:right" >{{lot.amount>=0?lot.amount:0 | number}}</td>


                            </tr>
                            </tbody>




                        </table>
                    </div>
                    <div class="float-left right-table parent">
                        <table class="table table-bordered" fixed-table-header>
                            <thead>
                            <tr class="gradient-header" style="height:55px">
                                <th  ng-repeat="req in requstions" colspan="3">{{req.name}}</th>
                            </tr>
                            <tr class="gradient-header inner-tr-height">
                                <th style="text-align:right"  ng-repeat-start="req in requstions">Quantity Ordered</th>
                                <th style="text-align:right" >Quantity Issued</th>
                                <th style="text-align:right"  ng-repeat-end>Gap</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr ng-repeat-start="p in soh " ng-init="productIndex = $index" class="inner-tr-height">
                                <td class="cell-input" style="padding-left: 15px; text-align:right; padding-right: 4px;"  ng-repeat-start="x in range(requstions.length) track by $index" rowspan="{{p.lots.length+1}}">{{getOrderedQuantity($index,p.productId) | number}}</td>
                                <td></td>
                                <td class="cell-input" style="padding-left: 15px; text-align:right; padding-right: 4px;" ng-class="{'td-error':getGap($index,p)>0,'td-warning':getGap($index,p)<0}"  rowspan="{{p.lots.length+1}}" ng-repeat-end>{{getGap($index,p) | number}}</td>
                            </tr>
                            <tr ng-repeat-end ng-repeat="lot in p.lots" ng-init="lotIndex = $index" class="inner-tr-height">
                                <td class="cell-input col-beginningBalance"  ng-repeat="req in requstions" >
                                    <input num-pos="true" num-neg="false" num-int="10" num-thousand="true" awnum ng-change="giveLot(req,p,lot,qty[$index][productIndex][lotIndex],$index,productIndex,lotIndex)"  ng-init="qty[$index][productIndex][lotIndex]=getQuantity(req,p,lot,$index)" ng-model="qty[$index][productIndex][lotIndex]"  ng-disabled="(lotIndex>0 && p.lots[lotIndex-1].amount>0)||((qty[$index][productIndex][lotIndex]=='' || qty[$index][productIndex][lotIndex]==0) && lot.amount<=0)" type="text">
                                </td>
                            </tr>



                            </tbody>


                        </table>
                    </div>

                </div>

            </div>

        </div>


        <div form-toolbar id="action_buttons" class="action-buttons">
            <div class="form-cell button-row">
                <input type="submit" class="btn btn-primary save-button"
                       value="Save" ng-disabled="!distributionDate" ng-if="!hasPermission('WMS_APPROVE_DISTRIBUTION')" ng-click="saveDistribution()"/>

                <input type="submit" class="btn btn-primary save-button"
                       value="Release for Picking" ng-disabled="!distributionDate" ng-if="!hasPermission('WMS_APPROVE_DISTRIBUTION')" ng-click="releaseForPickingDistribution()"/>

                <input type="submit"  class="btn btn-primary save-button" ng-if="hasPermission('WMS_APPROVE_DISTRIBUTION')"
                       value="Approve"  ng-disabled="!distributionDate" ng-click="approveDistribution()"/>

                <input id="cancelButton" type="button" class="btn btn-cancel cancel-button"   openlmis-message="button.cancel"
                       ng-click="cancel()"/>





            </div>

            <div class="toolbar-error" id="saveErrorMsgDiv" openlmis-message="error" ng-show="error"></div>
        </div>

    </form>


</div>

